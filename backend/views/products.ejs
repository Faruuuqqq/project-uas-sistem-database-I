<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Products Page</title>
    <meta name="description" content="">
  <meta name="keywords" content="">

  <!-- Favicons -->
  <link href="/assets/img/favicon.png" rel="icon">
  <link href="/assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Nunito:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="/assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
  <link href="/assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="/assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="/assets/vendor/drift-zoom/drift-basic.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="/assets/css/main.css" rel="stylesheet">
</head>
<body>
  <%- include('partials/header') %>

  <main class="main">
    <div class="page-title light-background">
      <div class="container d-lg-flex justify-content-between align-items-center">
        <h1 class="mb-2 mb-lg-0">Products</h1>
        <nav class="breadcrumbs">
          <ol>
            <li><a href="/">Home</a></li>
            <li class="current">Products</li>
          </ol>
        </nav>
      </div>
    </div>

    <section id="category-product-list" class="category-product-list section">
      <div class="container" data-aos="fade-up" data-aos-delay="100">
        <% if (products && products.length > 0) { %>
          <div class="row gy-4"> <%# gy-4 for vertical gutter between cards %>
            <% products.forEach(product => { %>
              <div class="col-lg-4 col-md-6"> <%# 3 products per row on large, 2 on medium %>
                <div class="product-box" data-product-id="<%= product.product_id %>">
                  <div class="product-thumb">
                    <% if(product.label) { %> <%# Assuming 'label' might exist for new/sale items in your DB/data %>
                      <span class="product-label"><%= product.label %></span>
                    <% } %>
                    <img src="" alt="<%= product.name %>" class="main-img" loading="lazy" />
                    <div class="product-overlay">
                      <div class="product-quick-actions">
                        <button type="button" class="quick-action-btn"><i class="bi bi-heart"></i></button>
                        <button type="button" class="quick-action-btn"><i class="bi bi-arrow-repeat"></i></button>
                        <button type="button" class="quick-action-btn"><a href="/products/<%= product.product_id %>" style="color: inherit;"><i class="bi bi-eye"></i></a></button> <%# Added link to detail page %>
                      </div> 
                      <div class="add-to-cart-container">
                        <% if(product.stock > 0) { %>
                          <button type="button" class="add-to-cart-btn" data-product-id="<%= product.product_id %>">Add to Cart</button>
                        <% } else { %>
                          <button type="button" class="add-to-cart-btn disabled" disabled>Sold Out</button> <%# Use disabled attribute %>
                        <% } %>
                      </div>
                    </div>
                  </div>
                  <div class="product-content">
                    <div class="product-details">
                      <h3 class="product-title"><a href="/products/<%= product.product_id %>"><%= product.name %></a></h3>
                      <div class="product-price">
                        <%# Assuming product.sale_price is a column if you have sales, or just use price %>
                        <% if(products.price && products.price < products.price) { %>
                          <span class="original">Rp <%= product.price.toLocaleString('id-ID') %></span>
                          <span class="sale">Rp <%= product.sale_price.toLocaleString('id-ID') %></span>
                        <% } else { %>
                          <span>Rp <%= product.price.toLocaleString('id-ID') %></span>
                        <% } %>
                      </div>
                    </div>
                    <%# Assuming product.rating is a column or calculated value from reviews, default to 0 %>
                    <div class="product-rating-container">
                      <div class="rating-stars">
                        <% const rating = products.rating || 0; %> <%# Default to 0 if no rating %>
                        <% for(let i=0; i < Math.floor(rating); i++) { %>
                          <i class="bi bi-star-fill"></i>
                        <% } %>
                        <% if(rating % 1 >= 0.5) { %>
                          <i class="bi bi-star-half"></i>
                        <% } %>
                        <% for(let i=0; i < 5 - Math.ceil(rating); i++) { %>
                          <i class="bi bi-star"></i>
                        <% } %>
                      </div>
                      <span class="rating-number"><%= rating.toFixed(1) %></span>
                    </div>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        <% } else { %>
          <div class="row">
            <div class="col-12 text-center">
              <p>Tidak ada produk yang ditemukan.</p>
            </div>
          </div>
        <% } %>
      </div>
    </section>
  </main>

  <%- include('partials/footer') %>


  <script>
    // Client-side JavaScript untuk tombol "Tambahkan ke Keranjang"
    document.addEventListener('DOMContentLoaded', () => {
      const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
      if (addToCartButtons.length === 0) {
        console.warn('Tidak ada tombol "Tambahkan ke Keranjang" ditemukan.');
        return;
      }
      document.querySelectorAll('.add-to-cart-btn').forEach(button => {
        // Hanya tambahkan event listener jika tombol tidak disabled
        if (!button.classList.contains('disabled')) {
          button.addEventListener('click', async (event) => {
            // Ambil productId dari data-product-id di tombol itu sendiri
            const productId = event.target.dataset.productId;
            const quantity = 1; // Default quantity for adding from product list

            try {
              const response = await fetch('/carts/add', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  // Jika authMiddleware bergantung pada cookie, browser akan mengirimnya secara otomatis.
                  // Jika Anda menyimpan token JWT di localStorage, Anda perlu menambahkan: 'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ productId, quantity })
              });

              const data = await response.json();

              if (response.ok) {
                alert(data.message || 'Produk berhasil ditambahkan ke keranjang!');
                // Opsional: Perbarui ikon keranjang di navigasi
              } else {
                alert('Gagal menambahkan produk ke keranjang: ' + (data.error || data.message || 'Terjadi kesalahan.'));
              }
            } catch (error) {
              console.error('Error adding to cart:', error);
              alert('Terjadi kesalahan jaringan atau server.');
            }
          });
        }
      });
    });
  </script>

  <script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/vendor/php-email-form/validate.js"></script>
  <script src="/assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="/assets/vendor/aos/aos.js"></script>
  <script src="/assets/vendor/imagesloaded/imagesloaded.pkgd.min.js"></script>
  <script src="/assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="/assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="/assets/vendor/drift-zoom/Drift.min.js"></script>
  <script src="/assets/vendor/purecounter/purecounter_vanilla.js"></script>

  <script src="/assets/js/main.js"></script>
</body>
</html>